name: Pyright Check

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read
  pull-requests: write # Required to post comments

jobs:
  pyright:
    runs-on: ubuntu-latest
    continue-on-error: true # Marks the job green even if Pyright fails
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install lightweight dependencies
        run: |
          python -m pip install --upgrade pip
          # Only install the essentials to prevent huge downloads (like torch)
          pip install fastapi uvicorn sqlalchemy pydantic httpx python-dotenv

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Pyright
        run: npm install pyright

      - name: Run Pyright and generate JSON
        id: pyright_run        run: |
          npx pyright --outputjson > pyright_report.json || true

      - name: Generate Summary Markdown
        id: pyright_summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const report = JSON.parse(fs.readFileSync('pyright_report.json', 'utf8'));
              const summary = report.summary;
              const errors = summary.errorCount;
              const warnings = summary.warningCount;
              const time = summary.timeInSec;

              // Create Markdown Content
              let output = `### Pyright Check Results ðŸ\n\n`;
              output += `| Type | Count |\n`;
              output += `| :--- | :---: |\n`;
              output += `| ðŸ”´ **Errors** | ${errors} |\n`;
              output += `| ðŸŸ¡ **Warnings** | ${warnings} |\n\n`;
              output += `*Analysis took ${time} seconds.*\n\n`;

              if (errors > 0) {
                output += `<details>\n<summary><strong>View Top Errors</strong></summary>\n\n`;
                output += `\`\`\`\n`;
                // Grab first 10 diagnostics as a preview
                const diagnostics = report.generalDiagnostics.slice(0, 10);
                diagnostics.forEach(d => {
                  output += `${d.file}:${d.range.start.line + 1} - ${d.message}\n`;
                });
                output += `\n...\n\`\`\`\n`;
                output += `</details>`;
              } else {
                output += `ðŸŽ‰ **No errors found!**`;
              }

              // Save to a file for the next step
              fs.writeFileSync('pyright_summary.md', output);

            } catch (error) {
              console.log("Could not parse Pyright report");
              fs.writeFileSync('pyright_summary.md', "### Pyright Error\nCould not parse report.");
            }

      - name: Post Pyright Summary to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: pyright_summary.md
          header: pyright-report # Keeps the comment sticky (updates it instead of posting new ones)
